# はじむ 外部パッケージ開発ガイド

はじむ言語の外部パッケージ（純 jp ソースパッケージ・C 拡張プラグイン）を開発・公開するための手引きです。

---

## 目次

1. [パッケージの種類](#パッケージの種類)
2. [ディレクトリ構成](#ディレクトリ構成)
3. [hajimu.json の書き方](#hajimujson-の書き方)
4. [jp ソースパッケージ](#jp-ソースパッケージ)
5. [C 拡張プラグイン（.hjp）](#c-拡張プラグインhjp)
6. [値型リファレンス](#値型リファレンス)
7. [プラットフォーム別ビルド](#プラットフォーム別ビルド)
8. [Makefile テンプレート](#makefile-テンプレート)
9. [パッケージの公開](#パッケージの公開)
10. [デバッグとテスト](#デバッグとテスト)
11. [よくある質問](#よくある質問)

---

## パッケージの種類

はじむのパッケージには 2 種類あります。

| 種類 | 拡張子 | 特徴 |
|---|---|---|
| **jp ソースパッケージ** | `.jp` | はじむ言語で記述。インタプリタがそのまま実行 |
| **C 拡張プラグイン** | `.hjp` | C/C++ でコンパイルした共有ライブラリ。高速処理・ネイティブ API に最適 |

> **注意**: `.hjp` は内部的に共有ライブラリ（macOS: `.dylib`、Linux: `.so`、Windows: `.dll`）と同じ形式ですが、拡張子を統一することでユーザーは OS の違いを意識する必要がありません。

---

## ディレクトリ構成

```
my_package/              ← パッケージのルートディレクトリ（= GitHub リポジトリ名）
  hajimu.json            ← パッケージマニフェスト（必須）
  README.md
  LICENSE
  Makefile               ← C 拡張の場合（推奨）
  src/
    my_plugin.c          ← C 拡張のソース
  include/
    my_plugin.h
  dist/                  ← ビルド済み .hjp の配置先（推奨名）
    my_package-macos.hjp
    my_package-linux-x64.hjp
    my_package-windows-x64.hjp
  examples/
    sample.jp
```

jp ソースパッケージの場合:

```
my_package/
  hajimu.json
  README.md
  main.jp                ← エントリポイント（hajimu.json の "メイン" で指定）
  utils.jp
  examples/
    sample.jp
```

---

## hajimu.json の書き方

パッケージルートに `hajimu.json` を置きます。

```json
{
  "名前": "my_package",
  "バージョン": "1.0.0",
  "説明": "パッケージの概要",
  "作者": "作者名",
  "メイン": "main.jp",
  "依存": {
    "other_package": "https://github.com/username/other_package"
  }
}
```

### C 拡張プラグインの場合

```json
{
  "名前": "my_plugin",
  "バージョン": "1.0.0",
  "説明": "C 拡張プラグインの例",
  "作者": "作者名",
  "メイン": "dist/my_plugin.hjp",
  "ビルドコマンド": "make build-all"
}
```

> `"メイン"` に `.hjp` パスを指定するとプラグインとして読み込まれます。はじむは OS に応じて `my_plugin-macos.hjp` / `my_plugin-linux-x64.hjp` / `my_plugin-windows-x64.hjp` を自動で選択します（後述）。

---

## jp ソースパッケージ

### 作成例

`main.jp`:

```jp
// 公開する関数を定義するだけ

関数 挨拶(名前) {
  返す "こんにちは、" + 名前 + "！"
}

関数 足す(値1, 値2) {
  返す 値1 + 値2
}
```

### 使用方法（利用者側）

```jp
取り込む "my_package" として パッケージ

表示(パッケージ["挨拶"]("世界"))  // → こんにちは、世界！
表示(パッケージ["足す"](3, 4))    // → 7
```

---

## C 拡張プラグイン（.hjp）

### 最小実装例

```c
#include "hajimu_plugin.h"

/* はじむから呼ばれる関数 */
static Value 二乗(int argc, Value *argv) {
    double x = argv[0].number;
    return hajimu_number(x * x);
}

/* 文字列を大文字に変換する例 */
static Value 叫ぶ(int argc, Value *argv) {
    const char *s = argv[0].string.data;
    char buf[1024];
    snprintf(buf, sizeof(buf), "%s！！！", s);
    return hajimu_string(buf);
}

/* 関数テーブル */
static HajimuPluginFunc functions[] = {
    {"二乗",   二乗,  1, 1},   /* 引数 1 個固定 */
    {"叫ぶ",   叫ぶ,  1, 1},
};

/* 初期化関数（必須・名前厳守） */
HAJIMU_PLUGIN_EXPORT HajimuPluginInfo *hajimu_plugin_init(void) {
    static HajimuPluginInfo info = {
        .name          = "my_plugin",
        .version       = "1.0.0",
        .author        = "作者名",
        .description   = "サンプルプラグイン",
        .functions     = functions,
        .function_count = 2,
    };
    return &info;
}
```

### コンパイル（シングルプラットフォーム）

```bash
# macOS
gcc -shared -fPIC -O2 \
    -I/path/to/jp/include \
    my_plugin.c -o dist/my_plugin-macos.hjp

# Linux
gcc -shared -fPIC -O2 \
    -I/path/to/jp/include \
    my_plugin.c -o dist/my_plugin-linux-x64.hjp -lm

# Windows (MinGW)
x86_64-w64-mingw32-gcc -shared -O2 \
    -I/path/to/jp/include \
    my_plugin.c -o dist/my_plugin-windows-x64.hjp
```

---

## 値型リファレンス

`hajimu_plugin.h` で提供されるヘルパー関数と型。

### 値の作成

| 関数 | 説明 | 例 |
|---|---|---|
| `hajimu_null()` | 無値を返す | `return hajimu_null();` |
| `hajimu_number(double n)` | 数値を返す | `return hajimu_number(3.14);` |
| `hajimu_bool(bool b)` | 真偽値を返す | `return hajimu_bool(true);` |
| `hajimu_string(const char *s)` | 文字列を返す | `return hajimu_string("hello");` |

### 値の参照

```c
static Value 処理(int argc, Value *argv) {
    // 型確認
    if (argv[0].type != VALUE_NUMBER) return hajimu_null();

    double n   = argv[0].number;           // 数値
    bool   b   = argv[0].boolean;          // 真偽値
    char  *s   = argv[0].string.data;      // 文字列
    int    len = argv[0].string.length;    // 文字列長

    // 配列要素
    for (int i = 0; i < argv[0].array.length; i++) {
        Value elem = argv[0].array.elements[i];
    }

    // 辞書
    Value val = dict_get(&argv[0], "キー");

    return hajimu_number(n * 2);
}
```

### 型判定マクロ

| 型 | ValueType 定数 |
|---|---|
| 無 | `VALUE_NULL` |
| 数値 | `VALUE_NUMBER` |
| 真偽 | `VALUE_BOOL` |
| 文字列 | `VALUE_STRING` |
| 配列 | `VALUE_ARRAY` |
| 辞書 | `VALUE_DICT` |

### `HajimuPluginFunc` 構造体

```c
typedef struct {
    const char     *name;      // はじむ側に公開する関数名（日本語 OK）
    HajimuPluginFn  fn;        // 関数ポインタ
    int             min_args;  // 最小引数数
    int             max_args;  // 最大引数数（-1 で可変長）
} HajimuPluginFunc;
```

---

## プラットフォーム別ビルド

### ファイル名規則

はじむは `取り込む "my_plugin"` を実行した際、以下の順序でファイルを検索します。

1. `my_plugin-<プラットフォームサフィックス>.hjp`（プラットフォーム固有）
2. `my_plugin.hjp`（汎用フォールバック）

| OS | アーキテクチャ | サフィックス | ファイル名例 |
|---|---|---|---|
| macOS | Apple Silicon (arm64) | `-macos-arm64` | `my_plugin-macos-arm64.hjp` |
| macOS | Intel (x86-64) | `-macos` | `my_plugin-macos.hjp` |
| Linux | x86-64 | `-linux-x64` | `my_plugin-linux-x64.hjp` |
| Linux | ARM64 | `-linux-arm64` | `my_plugin-linux-arm64.hjp` |
| Windows | x86-64 | `-windows-x64` | `my_plugin-windows-x64.hjp` |
| Windows | ARM64 | `-windows-arm64` | `my_plugin-windows-arm64.hjp` |

> **推奨**: `dist/` ディレクトリに全プラットフォームの `.hjp` を置き、`hajimu.json` の `"メイン"` を `"dist/my_plugin.hjp"` に設定してください。はじむが自動的に正しいファイルを選択します。

### hajimu_plugin.h のプラットフォームマクロ

プラグイン C ソース内で OS・アーキテクチャを分岐できます。

```c
#include "hajimu_plugin.h"

static Value 情報取得(int argc, Value *argv) {
#if defined(HAJIMU_OS_MACOS)
    return hajimu_string("macOS で動作中");
#elif defined(HAJIMU_OS_LINUX)
    return hajimu_string("Linux で動作中");
#elif defined(HAJIMU_OS_WINDOWS)
    return hajimu_string("Windows で動作中");
#else
    return hajimu_string("不明な OS");
#endif
}
```

| マクロ | 意味 |
|---|---|
| `HAJIMU_OS_MACOS` | macOS |
| `HAJIMU_OS_LINUX` | Linux |
| `HAJIMU_OS_WINDOWS` | Windows |
| `HAJIMU_OS_NAME` | OS 名の文字列リテラル |
| `HAJIMU_ARCH_ARM64` | ARM64 アーキテクチャ |
| `HAJIMU_ARCH_X64` | x86-64 アーキテクチャ |
| `HAJIMU_ARCH_NAME` | アーキテクチャ名の文字列リテラル |
| `HAJIMU_HJP_SUFFIX` | プラットフォームサフィックス文字列（`-linux-x64` など） |

---

## Makefile テンプレート

クロスプラットフォームビルド用の Makefile テンプレートです。

```makefile
# =============================================================================
# my_plugin — はじむ言語用 C 拡張プラグイン
# =============================================================================
PLUGIN_NAME = my_plugin
DIST        = dist
SRCS        = src/my_plugin.c

# jp/include の自動検索（インストール済み or ソースリポジトリ）
HAJIMU_INC  = $(abspath $(firstword $(wildcard \
    ../../jp/include \
    ../jp/include \
    $(HOME)/.hajimu/include \
)))

# クロスコンパイラ
LINUX_CC   ?= x86_64-linux-musl-gcc
WIN_CC     ?= x86_64-w64-mingw32-gcc

.PHONY: build-all build-macos build-linux build-windows

build-all: build-macos build-linux build-windows
	@echo "  全プラットフォームビルド完了: $(DIST)/"

build-macos:
	@mkdir -p $(DIST)
	cc -shared -fPIC -O2 -std=c11 \
	  -I$(HAJIMU_INC) -Iinclude \
	  $(SRCS) \
	  -o $(DIST)/$(PLUGIN_NAME)-macos.hjp
	@echo "  macOS: $(DIST)/$(PLUGIN_NAME)-macos.hjp"

build-linux:
	@mkdir -p $(DIST)
	$(LINUX_CC) -shared -fPIC -O2 -std=gnu11 \
	  -I$(HAJIMU_INC) -Iinclude \
	  $(SRCS) \
	  -Wl,--allow-shlib-undefined \
	  -o $(DIST)/$(PLUGIN_NAME)-linux-x64.hjp
	@echo "  Linux: $(DIST)/$(PLUGIN_NAME)-linux-x64.hjp"

build-windows:
	@mkdir -p $(DIST)
	$(WIN_CC) -shared -O2 -std=gnu11 \
	  -D_WIN32_WINNT=0x0601 -DWIN32_LEAN_AND_MEAN \
	  -I$(HAJIMU_INC) -Iinclude \
	  $(SRCS) \
	  -static-libgcc \
	  -o $(DIST)/$(PLUGIN_NAME)-windows-x64.hjp
	@echo "  Windows: $(DIST)/$(PLUGIN_NAME)-windows-x64.hjp"

clean:
	rm -rf $(DIST)
```

### クロスコンパイラのインストール（macOS 上）

macOS 一台から全プラットフォーム向けに出力できます。

```bash
# Linux 向け（musl libc、静的）
brew install FiloSottile/musl-cross/musl-cross

# Windows 向け（MinGW-w64）
brew install mingw-w64
```

---

## パッケージの公開

### 1. GitHub リポジトリに push

```bash
git init
git add .
git commit -m "initial release"
git remote add origin https://github.com/username/my_package
git push -u origin main
```

### 2. ユーザーのインストール方法

利用者のプロジェクトで:

```bash
# URL を指定してインストール
nihongo install https://github.com/username/my_package

# または hajimu.json に追記してから
nihongo install
```

`hajimu.json`（利用者側）:

```json
{
  "名前": "my_project",
  "依存": {
    "my_package": "https://github.com/username/my_package"
  }
}
```

### 3. 使用方法（利用者の jp コード）

```jp
取り込む "my_package" として プラグイン

変数 結果 = プラグイン["二乗"](5)
表示(結果)  // → 25
```

---

## デバッグとテスト

### はじむからプラグインを直接テスト

```jp
取り込む "./dist/my_plugin-macos.hjp" として プラグイン

テスト("二乗のテスト", 関数() {
  期待(プラグイン["二乗"](4), 16)
  期待(プラグイン["二乗"](0), 0)
  期待(プラグイン["二乗"](-3), 9)
})

テスト実行()
```

### エラーメッセージの出し方（C 側）

```c
#include <stdio.h>
#include "hajimu_plugin.h"

static Value 安全な割り算(int argc, Value *argv) {
    double 除数 = argv[1].number;
    if (除数 == 0) {
        fprintf(stderr, "[my_plugin] エラー: ゼロ除算\n");
        return hajimu_null();  // 無を返して呼び出し元に通知
    }
    return hajimu_number(argv[0].number / 除数);
}
```

### デバッグビルド

```bash
CFLAGS="-g -fsanitize=address" make build-macos
```

---

## よくある質問

### Q: `hajimu_plugin.h` はどこから取得しますか？

jp のソースリポジトリ (`jp/include/hajimu_plugin.h`) から取得してください。
将来的には `nihongo install-dev` コマンドで自動配置される予定です。

```bash
git clone https://github.com/ReoShiozawa/nihongo jp
# → jp/include/hajimu_plugin.h を使用
```

### Q: `_GNU_SOURCE` や `_DARWIN_C_SOURCE` はどこで定義しますか？

`hajimu_plugin.h` は `_POSIX_C_SOURCE 200809L` を定義します。
`dladdr` 等の GNU 拡張を使う場合は **インクルードより前** に定義してください。

```c
/* Linux: dladdr は GNU 拡張 */
#ifdef __linux__
  #define _GNU_SOURCE
#endif
/* macOS: _DARWIN_C_SOURCE で dladdr を有効化 */
#ifdef __APPLE__
  #define _DARWIN_C_SOURCE
#endif

#include "hajimu_plugin.h"
```

### Q: SDL2 / OpenGL など大きなライブラリを使いたい場合は？

Windows の場合は import lib（`.dll.a`）を vendor に含め、`-Wl,--allow-shlib-undefined` フラグで Linux 向けにビルドします（SDL2.dll は実行時に解決）。詳細は [engine_render](https://github.com/ReoShiozawa/hajimu_engine_render) の実装を参考にしてください。

### Q: プラグインから別の jp コードを呼び出せますか？

`hajimu_plugin_set_runtime` を実装することで jp のランタイムコールバックを受け取り、はじむ関数を呼び出せます。詳細は `hajimu_plugin.h` の `HajimuRuntime` 構造体を参照してください。

### Q: 関数名に日本語を使えますか？

はじむの識別子は UTF-8 なので日本語の関数名をそのまま使えます。

```c
static HajimuPluginFunc functions[] = {
    {"円の面積", 円の面積_fn, 1, 1},  // はじむ側から プラグイン["円の面積"](r) で呼べる
};
```

---

## 関連ドキュメント

- [REFERENCE.md](REFERENCE.md) — はじむ言語リファレンス
- [TUTORIAL.md](TUTORIAL.md) — はじむ入門チュートリアル
- [CONTRIBUTING.md](../CONTRIBUTING.md) — コントリビューションガイド
