/**
 * はじむ - バイトコード (.hjp) フォーマット定義
 *
 * .hjp ファイルは「ネイティブ C プラグイン」と「バイトコードパッケージ」の
 * 2 種類を統一した拡張子で管理する。先頭 4 バイトのマジックで判別する。
 *
 * ─────────────────────────────────────────────────────────────────
 *  バイトコード .hjp ファイル フォーマット (HJPB v1)
 * ─────────────────────────────────────────────────────────────────
 *   [0-3]    マジック: "HJPB"  (0x48 0x4A 0x50 0x42)
 *   [4]      バージョン major: 1
 *   [5]      バージョン minor: 0
 *   [6-9]    フラグ (uint32_t LE, 予約: 0)
 *              bit 0: 将来的圧縮フラグ (現在未使用)
 *   [10-13]  メタデータ JSON バイト長 (uint32_t LE)
 *   [14-N]   メタデータ JSON (UTF-8)
 *              例: {"name":"my_lib","version":"1.0.0","author":"","description":""}
 *   [N-N+3]  ソースコード バイト長 (uint32_t LE)
 *   [N+4..]  ソースコード (UTF-8, .jp ファイルの内容)
 * ─────────────────────────────────────────────────────────────────
 *
 * 判別ルール (plugin.c で実装):
 *   先頭 4 バイト == "HJPB" → バイトコード → bytecode_load() で処理
 *   それ以外                → ネイティブ C プラグイン → dlopen() で処理 (後方互換)
 *
 * 純粋スクリプトパッケージ (.jp):
 *   hajimu.json の "メイン" が ".jp" ファイルを指す場合、
 *   そのまま評価器が読み込む（バイトコード変換不要）。
 */

#ifndef BYTECODE_H
#define BYTECODE_H

#include <stdint.h>
#include <stdbool.h>
#include <stddef.h>

// =============================================================================
// マジック・バージョン定数
// =============================================================================

/** ファイル先頭の識別子 4 バイト */
#define HJPB_MAGIC          "HJPB"
#define HJPB_MAGIC_LEN      4

/** 現在のフォーマットバージョン */
#define HJPB_VERSION_MAJOR  1
#define HJPB_VERSION_MINOR  0

/** ヘッダー最小サイズ (マジック + major + minor + flags + meta_len) */
#define HJPB_HEADER_MIN     14

// =============================================================================
// バイトコードメタデータ
// =============================================================================

typedef struct {
    char name[256];         /**< パッケージ/モジュール名 */
    char version[64];       /**< バージョン文字列 */
    char author[256];       /**< 作者 */
    char description[512];  /**< 説明 */
} HjpbMeta;

// =============================================================================
// ファイル判別 API
// =============================================================================

/**
 * ファイルの先頭を読んで HJPB バイトコードかどうかを判定する。
 * @param path ファイルパス
 * @return バイトコードなら true、ネイティブプラグインまたは不明なら false
 */
bool hjpb_is_bytecode_file(const char *path);

/**
 * バッファの先頭がマジックバイト "HJPB" かどうかを判定する。
 * @param buf  読み込んだバッファ
 * @param size バッファサイズ
 */
bool hjpb_is_bytecode_buf(const uint8_t *buf, size_t size);

// =============================================================================
// エンコード (pack: .jp → .hjp)
// =============================================================================

/**
 * .jp ソースコードを HJPB バイトコード形式にエンコードしてファイルに書き出す。
 *
 * @param out_path    出力する .hjp ファイルパス
 * @param meta        パッケージメタデータ（name が空なら out_path から推定）
 * @param source      jp ソースコード文字列 (UTF-8)
 * @param source_len  ソースコードの長さ (バイト, 0 なら strlen)
 * @return 成功なら true
 */
bool hjpb_encode(const char *out_path, const HjpbMeta *meta,
                 const char *source, size_t source_len);

// =============================================================================
// デコード (unpack: .hjp → ソース取り出し)
// =============================================================================

/**
 * HJPB バイトコードファイルを読み込んでメタデータとソースを取り出す。
 *
 * @param path          読み込む .hjp ファイルパス
 * @param meta_out      メタデータ出力先（NULL で省略）
 * @param source_out    ソースコード出力先（呼び出し元が free() すること）
 * @param source_len_out ソースコード長出力先（NULL で省略）
 * @return 成功なら true
 */
bool hjpb_decode(const char *path, HjpbMeta *meta_out,
                 char **source_out, size_t *source_len_out);

// =============================================================================
// ユーティリティ
// =============================================================================

/**
 * HJPB バイトコード情報をコンソールに表示する（デバッグ・診断用）。
 */
void hjpb_print_info(const char *path);

#endif /* BYTECODE_H */
