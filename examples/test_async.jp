// ============================================
// 非同期処理・並列処理・スケジューラ・WebSocket テスト
// ============================================

変数 成功数 = 0
変数 失敗数 = 0

関数 テスト確認(名前, 結果値):
    もし 結果値 なら
        表示("  ✓ " + 名前)
        成功数 += 1
    それ以外
        表示("  ✗ " + 名前)
        失敗数 += 1
    終わり
終わり

// ============================================
// テスト1: 非同期実行と待機
// ============================================
表示("=== 非同期処理テスト ===")

// 非同期で関数を実行
変数 タスク1 = 非同期実行(関数():
    戻す 42
終わり)
テスト確認("非同期タスク作成", タスク1 > 0)

// タスク状態の確認
変数 確認状態 = タスク状態(タスク1)
テスト確認("タスク状態取得", 確認状態 != "不明")

// 待機して結果取得
変数 結果1 = 待機(タスク1)
テスト確認("非同期待機で結果取得", 結果1 == 42)

// 引数付き非同期実行
変数 タスク2 = 非同期実行(関数(x):
    戻す x * 2
終わり, 21)
変数 結果2 = 待機(タスク2)
テスト確認("引数付き非同期実行", 結果2 == 42)

// 複数の非同期タスク
変数 タスクA = 非同期実行(関数(): 戻す 10 終わり)
変数 タスクB = 非同期実行(関数(): 戻す 20 終わり)
変数 タスクC = 非同期実行(関数(): 戻す 30 終わり)

変数 全結果 = 全待機([タスクA, タスクB, タスクC])
テスト確認("全待機で複数結果取得", 長さ(全結果) == 3)
テスト確認("全待機の結果値", 全結果[0] + 全結果[1] + 全結果[2] == 60)

// ============================================
// テスト2: 並列実行
// ============================================
表示("")
表示("=== 並列処理テスト ===")

変数 並列結果 = 並列実行([関数(): 戻す 100 終わり, 関数(): 戻す 200 終わり, 関数(): 戻す 300 終わり])
テスト確認("並列実行の結果数", 長さ(並列結果) == 3)
テスト確認("並列実行の結果値合計", 並列結果[0] + 並列結果[1] + 並列結果[2] == 600)

// ============================================
// テスト3: 排他制御
// ============================================
表示("")
表示("=== 排他制御テスト ===")

変数 ロック = 排他作成()
テスト確認("排他制御作成", ロック >= 0)

// ============================================
// テスト4: チャネル
// ============================================
表示("")
表示("=== チャネルテスト ===")

変数 ch = チャネル作成(10)
テスト確認("チャネル作成", ch > 0)

// チャネルに値を送信
変数 送信OK = チャネル送信(ch, "こんにちは")
テスト確認("チャネル送信", 送信OK == 真)

// チャネルから値を受信
変数 受信値 = チャネル受信(ch)
テスト確認("チャネル受信", 受信値 == "こんにちは")

// 複数の値を送受信
チャネル送信(ch, 1)
チャネル送信(ch, 2)
チャネル送信(ch, 3)

変数 v1 = チャネル受信(ch)
変数 v2 = チャネル受信(ch)
変数 v3 = チャネル受信(ch)
テスト確認("チャネル複数値", v1 + v2 + v3 == 6)

// チャネルを閉じる
チャネル閉じる(ch)

// ============================================
// テスト5: スケジューラ（遅延実行）
// ============================================
表示("")
表示("=== スケジューラテスト ===")

変数 遅延ID = 遅延実行(関数():
    // 遅延後に実行される
終わり, 0.1)
テスト確認("遅延実行作成", 遅延ID > 0)

// 定期実行のテスト
変数 定期ID = 定期実行(関数():
    // 定期的に実行される
終わり, 0.5)
テスト確認("定期実行作成", 定期ID > 0)

// 少し待ってからスケジュール停止
待つ(0.2)
スケジュール停止(定期ID)
テスト確認("スケジュール停止", 真)

// 全スケジュール停止
全スケジュール停止()
テスト確認("全スケジュール停止", 真)

// ============================================
// テスト6: WebSocket（関数存在確認のみ）
// ============================================
表示("")
表示("=== WebSocketテスト ===")

// WS関数が存在することを確認（接続先がないので-1が返る）
変数 ws結果 = WS接続("ws://localhost:99999/test")
テスト確認("WS接続関数存在", ws結果 == -1)

変数 ws確認 = WS状態(-1)
テスト確認("WS状態関数存在", ws確認 == "不明")

WS切断(-1)
テスト確認("WS切断関数存在", 真)

// ============================================
// 結果サマリ
// ============================================
表示("")
表示("===========================")
表示("テスト結果: {成功数}/{成功数 + 失敗数} 成功")
もし 失敗数 == 0 なら
    表示("全テスト合格！ 🎉")
それ以外
    表示("{失敗数} 件のテストが失敗しました")
終わり
